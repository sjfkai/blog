<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="sjfkai,sjfkai@gmail.com"><title>Ubuntu下安装vsftpd并配置iptables · Just Blog</title><meta name="description" content="前言因为要用codeanywhere写代码，所以要搭建一个ftp服务器来保存项目。之前的服务器都是关闭防火墙iptables的。只要安装好vsftpd，就可以用了。最近打算了解一下iptables强制要求自己没有关掉防火墙。正好vsftpd的防火墙配置有些特殊，所以记录在这里。
安装参考Vsftpd"><meta name="keywords" content="blog,Just Blog,sjfkai,前端,大前端,程序员"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-110880274-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-110880274-1');</script></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Just Blog</a></h3></div></div><ul class="social-links"><li><a href="http://github.com/sjfkai"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1267679219'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s13.cnzz.com/z_stat.php%3Fid%3D1267679219%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/logo.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Ubuntu下安装vsftpd并配置iptables</a></h3></div><div class="post-content"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>因为要用<a href="https://codeanywhere.com/" target="_blank" rel="noopener">codeanywhere</a>写代码，所以要搭建一个ftp服务器来保存项目。之前的服务器都是关闭防火墙<code>iptables</code>的。只要安装好<code>vsftpd</code>，就可以用了。最近打算了解一下<code>iptables</code>强制要求自己没有关掉防火墙。正好<code>vsftpd</code>的防火墙配置有些特殊，所以记录在这里。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="http://wiki.ubuntu.org.cn/Vsftpd" target="_blank" rel="noopener">Vsftpd</a><br>官方文档写的太清楚了。我就不多说啦。这里只把配置字段的解释再贴一次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">listen=&lt;YES/NO&gt; :设置为YES时vsftpd以独立运行方式启动，设置为NO时以xinetd方式启动（xinetd是管理守护进程的，将服务集中管理，可以减少大量服务的资源消耗）</span><br><span class="line">listen_port=&lt;port&gt; :设置控制连接的监听端口号，默认为21</span><br><span class="line">listen_address=&lt;ip address&gt; :将在绑定到指定IP地址运行，适合多网卡</span><br><span class="line">connect_from_port_20=&lt;YES/NO&gt; :若为YES，则强迫FTP－DATA的数据传送使用port 20，默认YES</span><br><span class="line">pasv_enable=&lt;YES/NO&gt; :是否使用被动模式的数据连接，如果客户机在防火墙后，请开启为YES</span><br><span class="line">pasv_min_port=&lt;n&gt;</span><br><span class="line">pasv_max_port=&lt;m&gt; :设置被动模式后的数据连接端口范围在n和m之间,建议为50000－60000端口</span><br><span class="line">message_file=&lt;filename&gt; :设置使用者进入某个目录时显示的文件内容，默认为 .message</span><br><span class="line">dirmessage_enable=&lt;YES/NO&gt; :设置使用者进入某个目录时是否显示由message_file指定的文件内容</span><br><span class="line">ftpd_banner=&lt;message&gt; :设置用户连接服务器后的显示信息，就是欢迎信息</span><br><span class="line">banner_file=&lt;filename&gt; :设置用户连接服务器后的显示信息存放在指定的filename文件中</span><br><span class="line">connect_timeout=&lt;n&gt; :如果客户机连接服务器超过N秒，则强制断线，默认60</span><br><span class="line">accept_timeout=&lt;n&gt; :当使用者以被动模式进行数据传输时，服务器发出passive port指令等待客户机超过N秒，则强制断线，默认60</span><br><span class="line">accept_connection_timeout=&lt;n&gt; :设置空闲的数据连接在N秒后中断，默认120</span><br><span class="line">data_connection_timeout=&lt;n&gt; : 设置空闲的用户会话在N秒后中断，默认300</span><br><span class="line">max_clients=&lt;n&gt; : 在独立启动时限制服务器的连接数，0表示无限制</span><br><span class="line">max_per_ip=&lt;n&gt; :在独立启动时限制客户机每IP的连接数，0表示无限制（不知道是否跟多线程下载有没干系）</span><br><span class="line">local_enable=&lt;YES/NO&gt; :设置是否支持本地用户帐号访问</span><br><span class="line">guest_enable=&lt;YES/NO&gt; :设置是否支持虚拟用户帐号访问</span><br><span class="line">write_enable=&lt;YES/NO&gt; :是否开放本地用户的写权限</span><br><span class="line">local_umask=&lt;nnn&gt; :设置本地用户上传的文件的生成掩码，默认为077</span><br><span class="line">local_max_rate&lt;n&gt; :设置本地用户最大的传输速率，单位为bytes/sec，值为0表示不限制</span><br><span class="line">local_root=&lt;file&gt; :设置本地用户登陆后的目录，默认为本地用户的主目录</span><br><span class="line">chroot_local_user=&lt;YES/NO&gt; :当为YES时，所有本地用户可以执行chroot</span><br><span class="line">chroot_list_enable=&lt;YES/NO&gt; </span><br><span class="line">chroot_list_file=&lt;filename&gt; :当chroot_local_user=NO 且 chroot_list_enable=YES时，只有filename文件指定的用户可以执行chroot</span><br><span class="line">anonymous_enable=&lt;YES/NO&gt; :设置是否支持匿名用户访问</span><br><span class="line">anon_max_rate=&lt;n&gt; :设置匿名用户的最大传输速率，单位为B/s，值为0表示不限制</span><br><span class="line">anon_world_readable_only=&lt;YES/NO&gt; 是否开放匿名用户的浏览权限</span><br><span class="line">anon_upload_enable=&lt;YES/NO&gt; 设置是否允许匿名用户上传</span><br><span class="line">anon_mkdir_write_enable=&lt;YES/NO&gt; :设置是否允许匿名用户创建目录</span><br><span class="line">anon_other_write_enable=&lt;YES/NO&gt; :设置是否允许匿名用户其他的写权限（注意，这个在安全上比较重要，一般不建议开，不过关闭会不支持续传）</span><br><span class="line">anon_umask=&lt;nnn&gt; :设置匿名用户上传的文件的生成掩码，默认为077</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="FTP两种模式的区别："><a href="#FTP两种模式的区别：" class="headerlink" title="FTP两种模式的区别："></a>FTP两种模式的区别：</h3><blockquote>
<p>PORT（主动）模式</p>
</blockquote>
<p>所谓主动模式，指的是FTP服务器“主动”去连接客户端的数据端口来传输数据，其过程具体来说就是：客户端从一个任意的非特权端口N（N&gt;1024）连接到FTP服务器的命令端口（即tcp 21端口），紧接着客户端开始监听端口N+1，并发送FTP命令“port N+1”到FTP服务器。然后服务器会从它自己的数据端口（20）“主动”连接到客户端指定的数据端口（N+1），这样客户端就可以和ftp服务器建立数据传输通道了。</p>
<blockquote>
<p>PASV（被动）模式</p>
</blockquote>
<p>所谓被动模式，指的是FTP服务器“被动”等待客户端来连接自己的数据端口，其过程具体是：当开启一个FTP连接时，客户端打开两个任意的非特权本地端口（N &gt;1024和N+1）。第一个端口连接服务器的21端口，但与主动方式的FTP不同，客户端不会提交PORT命令并允许服务器来回连它的数据端口，而是提交PASV命令。这样做的结果是服务器会开启一个任意的非特权端口（P &gt; 1024），并发送PORT P命令给客户端。然后客户端发起从本地端口N+1到服务器的端口P的连接用来传送数据。（注意此模式下的FTP服务器不需要开启tcp 20端口了）</p>
<h4 id="两种模式的比较："><a href="#两种模式的比较：" class="headerlink" title="两种模式的比较："></a>两种模式的比较：</h4><p>PORT（主动）模式模式只要开启服务器的21和20端口，而PASV（被动）模式需要开启服务器大于1024所有tcp端口和21端口。</p>
<p>从网络安全的角度来看的话似乎ftp PORT模式更安全，而ftp PASV更不安全，那么为什么RFC要在ftp PORT基础再制定一个ftp PASV模式呢？其实RFC制定ftp PASV模式的主要目的是为了数据传输安全角度出发的，因为ftp port使用固定20端口进行传输数据，那么作为黑客很容使用sniffer等探嗅器抓取ftp数据，这样一来通过ftp PORT模式传输数据很容易被黑客窃取，因此使用PASV方式来架设ftp server是最安全绝佳方案。</p>
<p>因此：如果只是简单的为了文件共享，完全可以禁用PASV模式，解除开放大量端口的威胁，同时也为防火墙的设置带来便利。</p>
<p><strong>不幸的是</strong>，FTP工具或者浏览器默认使用的都是PASV模式连接FTP服务器，因此，必须要使vsftpd在开启了防火墙的情况下，也能够支持PASV模式进行数据访问。</p>
<hr>
<h3 id="防火墙iptables"><a href="#防火墙iptables" class="headerlink" title="防火墙iptables"></a>防火墙iptables</h3><p>配置<code>/etc/vsfptd.conf</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pasv_enable=YES</span><br><span class="line">pasv_min_port=50000</span><br><span class="line">pasv_max_port=60000</span><br></pre></td></tr></table></figure></p>
<p>防火墙不仅要打开20 21 端口 还要打开 50000-60000端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 21 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 20 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 50000:60000 -j ACCEPT</span><br></pre></td></tr></table></figure></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2015-04-07</span><i class="fa fa-tag"></i><a href="/tags/linux/" title="linux" class="tag">linux </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://blog.sjfkai.com/2015/04/07/Ubuntu下安装vsftpd并配置iptables/,Just Blog,Ubuntu下安装vsftpd并配置iptables,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2015/05/04/linux下解压常用tar命令/" title="linux下解压常用tar命令" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2015/03/23/grab12306/" title="抓取12306列车时刻表" class="btn">下一篇</a></li></ul></div><a id="comments"></a><div id="gitalk_thread"></div><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script>(function() {
    var gitalk = new Gitalk({
        clientID: '42fc6cc03e9748504521',
        clientSecret: '276e368ccf374058acd40e6e5c9dc9589e08460d',
        repo: 'blog',
        owner: 'sjfkai',
        admin: 'sjfkai',
        id: md5(location.pathname),      // Ensure uniqueness and length less than 50
        distractionFreeMode: 'true'  // Facebook-like distraction free mode
    })
    gitalk.render('gitalk_thread')
})();</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>